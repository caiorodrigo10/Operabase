# Fluxo de Funcionamento do Sistema - Operabase Railway

## üéØ Vis√£o Geral dos Fluxos

Este documento detalha como todos os sistemas implementados funcionam em conjunto, com exemplos pr√°ticos e diagramas de fluxo.

## üîÑ Fluxo Principal: Conversa com Pausa Autom√°tica da AI

### 1. Estado Inicial
```
Conversa: ai_active = true
Livia Config: off_duration = 1, off_unit = "minutos"
Middleware: Rodando a cada 30 segundos
```

### 2. Profissional Envia Mensagem
```
POST /api/conversations-simple/559887694034551150391104/messages
{
  "content": "Ol√°, como posso ajudar?"
}
```

### 3. Processamento da Mensagem
```typescript
// 1. Salvar mensagem no banco
const message = await supabaseAdmin.from('messages').insert({
  conversation_id: '559887694034551150391104',
  content: 'Ol√°, como posso ajudar?',
  sender_type: 'professional',
  sender_id: 4,
  timestamp: '2025-01-07T20:41:23.456-03:00' // Bras√≠lia
});

// 2. Pausar AI automaticamente
await aiPauseService.pauseAIForManualMessage(conversationId, userId);
```

### 4. C√°lculo da Pausa
```typescript
// Buscar configura√ß√£o da Livia
const config = { off_duration: 1, off_unit: 'minutos' };

// Calcular timestamp de pausa
const pauseDuration = 1 * 60 * 1000; // 1 minuto em ms
const pauseUntil = new Date(Date.now() + pauseDuration);
// pauseUntil = '2025-01-07T20:42:23.456-03:00'

// Atualizar conversa
await supabaseAdmin.from('conversations').update({
  ai_active: false,
  ai_paused_until: pauseUntil.toISOString(),
  ai_paused_by_user_id: 4,
  ai_pause_reason: 'manual_message'
});
```

### 5. Estado Durante a Pausa
```
Conversa: {
  ai_active: false,
  ai_paused_until: '2025-01-07T20:42:23.456-03:00',
  ai_paused_by_user_id: 4,
  ai_pause_reason: 'manual_message'
}
```

### 6. Middleware Verifica Pausa (a cada 30s)
```typescript
// Verificar pausas expiradas
const now = '2025-01-07T20:42:30.000-03:00';
const expiredPauses = await supabaseAdmin
  .from('conversations')
  .select('*')
  .eq('ai_active', false)
  .eq('ai_pause_reason', 'manual_message')
  .lte('ai_paused_until', now);

// Encontrada pausa expirada -> Reativar AI
await supabaseAdmin.from('conversations').update({
  ai_active: true,
  ai_paused_until: null,
  ai_paused_by_user_id: null,
  ai_pause_reason: null
});
```

### 7. Estado Final
```
Conversa: {
  ai_active: true,
  ai_paused_until: null,
  ai_paused_by_user_id: null,
  ai_pause_reason: null
}
```

## üìÅ Fluxo de Upload de Arquivos

### 1. Upload de Imagem
```typescript
// Frontend
const formData = new FormData();
formData.append('file', imageFile);

const response = await fetch('/api/conversations-simple/559887694034551150391104/upload', {
  method: 'POST',
  body: formData
});
```

### 2. Processamento no Backend
```typescript
// 1. Salvar arquivo no sistema
const file = req.file; // Multer middleware
const filePath = `/uploads/${conversationId}/${file.filename}`;

// 2. Criar mensagem
const message = await supabaseAdmin.from('messages').insert({
  conversation_id: conversationId,
  content: `Arquivo enviado: ${file.originalname}`,
  sender_type: 'professional',
  message_type: 'image',
  timestamp: getBrasiliaTimestamp()
});

// 3. Criar attachment
const attachment = await supabaseAdmin.from('attachments').insert({
  message_id: message.id,
  file_name: file.originalname,
  file_type: file.mimetype,
  file_size: file.size,
  file_path: filePath,
  created_at: getBrasiliaTimestamp()
});

// 4. Pausar AI automaticamente
await aiPauseService.pauseAIForManualMessage(conversationId, userId);
```

### 3. Resultado Final
```json
{
  "message": {
    "id": 123,
    "conversation_id": "559887694034551150391104",
    "content": "Arquivo enviado: imagem.jpg",
    "sender_type": "professional",
    "message_type": "image",
    "timestamp": "2025-01-07T20:41:23.456-03:00"
  },
  "attachment": {
    "id": 45,
    "message_id": 123,
    "file_name": "imagem.jpg",
    "file_type": "image/jpeg",
    "file_size": 245760,
    "file_path": "/uploads/559887694034551150391104/1736288483456-imagem.jpg"
  }
}
```

## üéµ Fluxo de Upload de √Åudio

### 1. Upload de √Åudio
```typescript
// Frontend
const formData = new FormData();
formData.append('audio', audioBlob);

const response = await fetch('/api/audio/voice-message/559887694034551150391104', {
  method: 'POST',
  body: formData
});
```

### 2. Processamento no Backend
```typescript
// 1. Salvar √°udio
const audioFile = req.file;
const audioPath = `/uploads/audio/${audioFile.filename}`;

// 2. Criar mensagem de √°udio
const message = await supabaseAdmin.from('messages').insert({
  conversation_id: conversationId,
  content: 'Mensagem de √°udio enviada',
  sender_type: 'professional',
  message_type: 'audio',
  timestamp: getBrasiliaTimestamp()
});

// 3. Criar attachment
const attachment = await supabaseAdmin.from('attachments').insert({
  message_id: message.id,
  file_name: audioFile.originalname,
  file_type: audioFile.mimetype,
  file_path: audioPath,
  created_at: getBrasiliaTimestamp()
});

// 4. Pausar AI
await aiPauseService.pauseAIForManualMessage(conversationId, userId);
```

### 3. Integra√ß√£o com N8N (Transcri√ß√£o)
```typescript
// N8N recebe notifica√ß√£o do upload de √°udio
// Processa transcri√ß√£o via Whisper/OpenAI
// Envia resultado via webhook

// POST /api/transcription/webhook
{
  "conversationId": "559887694034551150391104",
  "messageId": 123,
  "transcription": "Texto transcrito do √°udio..."
}

// Backend salva transcri√ß√£o
const transcriptionMessage = await supabaseAdmin.from('messages').insert({
  conversation_id: conversationId,
  content: `Transcri√ß√£o: ${transcription}`,
  sender_type: 'system',
  message_type: 'text',
  timestamp: getBrasiliaTimestamp()
});
```

## ‚öôÔ∏è Fluxo de Configura√ß√µes

### 1. Configura√ß√µes da Cl√≠nica
```typescript
// Carregar configura√ß√µes
const response = await fetch('/api/clinic/1/config');
const clinicConfig = await response.json();

// Exemplo de dados retornados
{
  "id": 1,
  "name": "Cl√≠nica Operabase Atualizada",
  "responsible": "Dr. Teste",
  "phone": "+5511987654321",
  "email": "teste@operabase.com",
  "working_days": ["monday", "tuesday", "thursday", "friday"],
  "work_start": "09:00",
  "work_end": "17:00",
  "specialties": [
    "Psicologia Cl√≠nica",
    "TDAH em Adultos",
    "TDAH Infantil",
    "Terapia Cognitivo-Comportamental"
  ]
}
```

### 2. Configura√ß√µes da Livia
```typescript
// Carregar configura√ß√µes
const response = await fetch('/api/livia/config');
const liviaConfig = await response.json();

// Exemplo de dados retornados
{
  "id": 1,
  "clinic_id": 1,
  "prompt": "Atue como a L√≠via, atendente fixa e humanizada da...",
  "off_duration": 1,
  "off_unit": "minutos"
}

// Salvar configura√ß√µes
const updateResponse = await fetch('/api/livia/config', {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    prompt: "Novo prompt...",
    off_duration: 5,
    off_unit: "minutos"
  })
});
```

## üîÑ Fluxo de Controle Manual da AI

### 1. Toggle AI (Desativar)
```typescript
// Frontend
const response = await fetch('/api/conversations-simple/559887694034551150391104/ai-toggle', {
  method: 'PATCH',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ ai_active: false })
});

// Backend
await aiPauseService.deactivateAI(conversationId, userId);

// Resultado
{
  ai_active: false,
  ai_paused_until: null,
  ai_paused_by_user_id: 4,
  ai_pause_reason: 'manual'
}
```

### 2. Toggle AI (Reativar)
```typescript
// Frontend
const response = await fetch('/api/conversations-simple/559887694034551150391104/ai-toggle', {
  method: 'PATCH',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ ai_active: true })
});

// Backend
await aiPauseService.reactivateAI(conversationId);

// Resultado
{
  ai_active: true,
  ai_paused_until: null,
  ai_paused_by_user_id: null,
  ai_pause_reason: null
}
```

### 3. Diferen√ßa entre Pausas
```typescript
// Pausa Autom√°tica (por mensagem)
{
  ai_active: false,
  ai_paused_until: '2025-01-07T20:42:23.456-03:00', // Timestamp futuro
  ai_pause_reason: 'manual_message' // Middleware pode reativar
}

// Pausa Manual (por usu√°rio)
{
  ai_active: false,
  ai_paused_until: null, // Sem timestamp
  ai_pause_reason: 'manual' // Middleware N√ÉO reativa
}
```

## üìä Fluxo de Monitoramento

### 1. Logs Estruturados
```typescript
// Exemplo de logs durante uma opera√ß√£o
console.log('üîç Sending message to conversation: 559887694034551150391104');
console.log('‚úÖ Message saved to database: 123');
console.log('‚è∏Ô∏è AI pausada para conversa 559887694034551150391104 por 1 minutos');
console.log('üîÑ AI PAUSE: Verificando conversas com pausa de IA expirada...');
console.log('‚úÖ AI PAUSE: IA reativada para conversa 559887694034551150391104 (pausa expirou)');
```

### 2. M√©tricas de Performance
```typescript
// Exemplo de logs de performance
console.log('‚ö° DB Query completed in 110 ms');
console.log('üìä Found conversations: 5');
console.log('‚ö° Performance: Processed 3 messages in 170 ms');
```

## üïê Fluxo de Timestamps (Bras√≠lia)

### 1. Fun√ß√£o Unificada
```typescript
const getBrasiliaTimestamp = () => {
  const now = new Date();
  const saoPauloOffset = -3 * 60; // GMT-3 em minutos
  const saoPauloTime = new Date(now.getTime() + saoPauloOffset * 60000);
  return saoPauloTime.toISOString();
};

// Exemplo de uso
const timestamp = getBrasiliaTimestamp();
// "2025-01-07T20:41:23.456Z" (representa 17:41 hor√°rio de Bras√≠lia)
```

### 2. Aplica√ß√£o em Todos os Sistemas
```typescript
// Mensagens de texto
const message = await supabaseAdmin.from('messages').insert({
  timestamp: getBrasiliaTimestamp(),
  created_at: getBrasiliaTimestamp()
});

// Upload de arquivos
const attachment = await supabaseAdmin.from('attachments').insert({
  created_at: getBrasiliaTimestamp()
});

// Transcri√ß√µes
const transcription = await supabaseAdmin.from('messages').insert({
  timestamp: getBrasiliaTimestamp(),
  created_at: getBrasiliaTimestamp()
});
```

## üì± Fluxo de Interface do Usu√°rio

### 1. Carregamento de Conversas
```typescript
// 1. Buscar lista de conversas
const conversations = await fetch('/api/conversations-simple?clinic_id=1');

// 2. Exibir lista com status da AI
conversations.map(conv => ({
  id: conv.id,
  name: conv.contact_name,
  aiActive: conv.ai_active, // true/false
  aiPausedUntil: conv.ai_paused_until // timestamp ou null
}));
```

### 2. Abertura de Conversa
```typescript
// 1. Buscar detalhes da conversa
const conversation = await fetch('/api/conversations-simple/559887694034551150391104');

// 2. Exibir mensagens ordenadas por timestamp
const messages = conversation.messages.sort((a, b) => 
  new Date(a.timestamp) - new Date(b.timestamp)
);

// 3. Exibir status da AI
const aiStatus = conversation.ai_active ? 'Ativa' : 'Pausada';
```

### 3. Envio de Mensagem
```typescript
// 1. Usu√°rio digita mensagem
const content = "Ol√°, como posso ajudar?";

// 2. Enviar mensagem
const response = await fetch('/api/conversations-simple/559887694034551150391104/messages', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ content })
});

// 3. Atualizar interface
// - Adicionar mensagem na lista
// - Mostrar que AI foi pausada
// - Iniciar contagem regressiva (1 minuto)
```

## üîç Exemplos Pr√°ticos Reais

### Exemplo 1: Envio de Mensagem de Texto
```bash
# 1. Estado inicial
Conversa 559887694034551150391104: ai_active = true

# 2. Profissional envia mensagem
POST /api/conversations-simple/559887694034551150391104/messages
Body: { "content": "Ol√°, preciso de ajuda" }

# 3. Logs do sistema
üîç Sending message to conversation: 559887694034551150391104
‚úÖ Message saved to database: 124
‚è∏Ô∏è AI pausada para conversa 559887694034551150391104 por 1 minutos

# 4. Estado ap√≥s envio
Conversa 559887694034551150391104: {
  ai_active: false,
  ai_paused_until: "2025-01-07T20:42:23.456Z",
  ai_pause_reason: "manual_message"
}

# 5. Middleware verifica (30s depois)
üîÑ AI PAUSE: Verificando conversas com pausa de IA expirada...
‚ÑπÔ∏è AI PAUSE: Nenhuma pausa de IA expirada encontrada

# 6. Middleware verifica (1 minuto depois)
üîÑ AI PAUSE: Verificando conversas com pausa de IA expirada...
üîÑ AI PAUSE: Encontradas 1 pausas expiradas para reativar
‚úÖ AI PAUSE: IA reativada para conversa 559887694034551150391104 (pausa expirou)
```

### Exemplo 2: Upload de Imagem
```bash
# 1. Upload de imagem
POST /api/conversations-simple/559887694034551150391104/upload
Content-Type: multipart/form-data
File: imagem.jpg (245KB)

# 2. Logs do sistema
üìÅ Uploading file to conversation: 559887694034551150391104
üìÑ File details: { name: "imagem.jpg", type: "image/jpeg", size: 245760 }
‚úÖ File uploaded successfully: 125
‚è∏Ô∏è AI pausada para conversa 559887694034551150391104 por 1 minutos

# 3. Resultado
Message: {
  id: 125,
  content: "Arquivo enviado: imagem.jpg",
  message_type: "image",
  timestamp: "2025-01-07T17:41:23.456-03:00"
}
Attachment: {
  id: 46,
  file_name: "imagem.jpg",
  file_path: "/uploads/559887694034551150391104/1736288483456-imagem.jpg"
}
```

### Exemplo 3: Configura√ß√£o da Livia
```bash
# 1. Alterar dura√ß√£o de pausa
PUT /api/livia/config
Body: { "off_duration": 5, "off_unit": "minutos" }

# 2. Logs do sistema
üîÑ Atualizando configura√ß√µes da Livia para clinic_id: 1
‚úÖ Configura√ß√µes da Livia atualizadas

# 3. Pr√≥xima mensagem usar√° nova configura√ß√£o
POST /api/conversations-simple/559887694034551150391104/messages
Body: { "content": "Teste com nova configura√ß√£o" }

# 4. AI pausada por 5 minutos agora
‚è∏Ô∏è AI pausada para conversa 559887694034551150391104 por 5 minutos
```

## üîß Troubleshooting

### Problema: AI n√£o reativa automaticamente
```bash
# Verificar logs do middleware
üîÑ AI PAUSE: Verificando conversas com pausa de IA expirada...
‚ÑπÔ∏è AI PAUSE: Nenhuma pausa de IA expirada encontrada

# Verificar estado da conversa
SELECT ai_active, ai_paused_until, ai_pause_reason 
FROM conversations 
WHERE id = '559887694034551150391104';

# Poss√≠veis causas:
# 1. ai_pause_reason = 'manual' (n√£o reativa automaticamente)
# 2. ai_paused_until ainda no futuro
# 3. Middleware n√£o est√° rodando
```

### Problema: Timestamps incorretos
```bash
# Verificar fun√ß√£o getBrasiliaTimestamp
const timestamp = getBrasiliaTimestamp();
console.log('Timestamp:', timestamp);
console.log('Hora local:', new Date(timestamp).toLocaleString('pt-BR'));

# Deve mostrar hor√°rio de Bras√≠lia (GMT-3)
```

### Problema: Upload de arquivo falha
```bash
# Verificar logs de upload
üìÅ Uploading file to conversation: 559887694034551150391104
üìÑ File details: { name: "arquivo.pdf", type: "application/pdf", size: 1024000 }
‚ùå Erro no upload: File too large

# Verificar configura√ß√£o do multer
const upload = multer({
  limits: { fileSize: 10 * 1024 * 1024 } // 10MB
});
```

---

## üìã Resumo dos Fluxos Implementados

### ‚úÖ Fluxos Funcionais
1. **Envio de Mensagem** ‚Üí **Pausa Autom√°tica da AI** ‚Üí **Reativa√ß√£o Autom√°tica**
2. **Upload de Arquivo** ‚Üí **Cria√ß√£o de Attachment** ‚Üí **Pausa Autom√°tica da AI**
3. **Upload de √Åudio** ‚Üí **Transcri√ß√£o N8N** ‚Üí **Pausa Autom√°tica da AI**
4. **Configura√ß√£o da Cl√≠nica** ‚Üí **Salvamento** ‚Üí **Atualiza√ß√£o Interface**
5. **Configura√ß√£o da Livia** ‚Üí **Altera√ß√£o Dura√ß√£o Pausa** ‚Üí **Aplica√ß√£o Imediata**
6. **Toggle Manual da AI** ‚Üí **Pausa/Reativa√ß√£o** ‚Üí **Persist√™ncia Estado**

### üîÑ Processos em Background
1. **Middleware AI Pause Checker** ‚Üí **Verifica√ß√£o a cada 30s** ‚Üí **Reativa√ß√£o Autom√°tica**
2. **Logs Estruturados** ‚Üí **Monitoramento em Tempo Real** ‚Üí **Debug Facilitado**
3. **Timestamp Unificado** ‚Üí **Bras√≠lia GMT-3** ‚Üí **Consist√™ncia Total**

---

*Documenta√ß√£o de fluxos funcionais*
*Atualizada em: Janeiro 2025*
*Vers√£o: v1.0 Fluxos Completos*
*Status: ‚úÖ Totalmente Documentado* 
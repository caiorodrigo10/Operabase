files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_start_server.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -xe
      
      # Log startup process
      echo "$(date): Starting Node.js application startup process" >> /var/log/nodejs-startup.log
      
      # Change to app directory
      cd /var/app/current
      
      # Check if server directory exists
      if [ ! -d "server" ]; then
        echo "$(date): ERROR - server directory not found" >> /var/log/nodejs-startup.log
        exit 1
      fi
      
      # Check if compiled JavaScript exists
      if [ ! -f "server/dist/index.js" ]; then
        echo "$(date): ERROR - server/dist/index.js not found, attempting compilation" >> /var/log/nodejs-startup.log
        cd server
        npm run build:simple || {
          echo "$(date): ERROR - TypeScript compilation failed" >> /var/log/nodejs-startup.log
          exit 1
        }
        cd ..
      fi
      
      # Verify the compiled file exists
      if [ ! -f "server/dist/index.js" ]; then
        echo "$(date): ERROR - server/dist/index.js still not found after compilation" >> /var/log/nodejs-startup.log
        exit 1
      fi
      
      echo "$(date): All checks passed, server should start normally" >> /var/log/nodejs-startup.log
      
      # Test if port 8080 is available
      if netstat -tuln | grep :8080; then
        echo "$(date): WARNING - Port 8080 already in use" >> /var/log/nodejs-startup.log
        # Kill any process using port 8080
        fuser -k 8080/tcp || true
        sleep 2
      fi
      
      echo "$(date): Startup script completed successfully" >> /var/log/nodejs-startup.log

container_commands:
  01_create_log_file:
    command: "touch /var/log/nodejs-startup.log && chmod 666 /var/log/nodejs-startup.log"
  02_install_dependencies:
    command: "cd /var/app/staging && npm install --production=false"
  03_compile_typescript:
    command: "cd /var/app/staging/server && npm run build:simple"
    ignoreErrors: true 